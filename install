#!/bin/bash
set -eu -o pipefail

function help () {
	echo "$(basename ${0}): Install forklift pallet manager"
	echo
	echo "Usage: $(basename ${0})"
	echo
}

SELF_DIR=$(cd $(dirname ${0}) && pwd -P)
SELF=${SELF_DIR}/$(basename ${0})

if [[ $# -eq 1 ]]; then
	COMMAND="${1}"
	case ${COMMAND} in
		-h|--help|help)
		help
		exit 0
		;;
		-d|--download|download)
		# Execute the first phase, which is the default operation to make life easy by allowing the user to "curl installer | bash"
		# Note that the installer is split in phases to ensure even an old installer can install a new version
		;;
		-i|--install|install)
		# Second phase of the installer, responsible for actually installing *this* version of forklift
		echo "Installing forklift"
		. ${SELF_DIR}/builtin/common/source
		BIN_DIR=${FLCACHE_ROOT}/bin
		mkdir -p ${BIN_DIR}
		if [ ! -f ${BIN_DIR}/forklift ]; then
cat > ${BIN_DIR}/forklift <<EOF
#!/bin/bash
${SELF_DIR}/forklift \$@
EOF
			chmod 755 ${BIN_DIR}/forklift
		fi
		
		if ! grep -qF "forklift" ~/.bash_profile; then
			echo "Adding forklift to path by modifying ~/.bash_profile"
			echo "export PATH=\"\${PATH}:${BIN_DIR}\"" >> ~/.bash_profile
			echo "Please create a new bash shell to use forklift"
		fi
		echo "Success!"
		exit 0
		;;
		*)
		echo "Unrecognized command ${COMMAND}"
		exit 1
		;;
	esac
elif [[ $# -gt 0 ]]; then
	echo "No arguments allowed"
	exit 1
fi

TEMPDIR=$(mktemp -d)
pushd ${TEMPDIR} 2>&1 >/dev/null
	# First phase of the installer, responsible for obtaining a local copy of forklift which can install intself
	RELEASE_ORG="g2forge"
	RELEASE_REPO="forklift"
	RELEASE_JSON="release.json"
	RELEASE_TARGZ="release.tar.gz"
	
	echo "Getting information about current release"
	curl https://api.github.com/repos/${RELEASE_ORG}/${RELEASE_REPO}/releases/latest 2> /dev/null > ${RELEASE_JSON}
	RELEASE_TARBALL_URL=$(grep -F "tarball_url" ${RELEASE_JSON} | sed -e 's/[^"]*"tarball_url":[^"]*"\([^"]*\)",/\1/')
	RELEASE_TAG_NAME=$(grep -F "tag_name" ${RELEASE_JSON} | sed -e 's/[^"]*"tag_name":[^"]*"\([^"]*\)",/\1/')
	
	echo "Downloading forklift ${RELEASE_TAG_NAME}"
	curl -L ${RELEASE_TARBALL_URL} > ${RELEASE_TARGZ}
	tar -xf ${RELEASE_TARGZ}
	RELEASE_DIR=$(find ./ -maxdepth 1 -mindepth 1 -type d | grep -F "${RELEASE_ORG}-${RELEASE_REPO}-" | head -n 1)
	
	echo "Running installer for ${RELEASE_TAG_NAME}"
	# Note that this will download, import and then run the installer
	${RELEASE_DIR}/forklift run com.github ${RELEASE_ORG}/${RELEASE_REPO} ${RELEASE_TAG_NAME} install --install
popd 2>&1 >/dev/null
rm -rf ${TEMPDIR}
